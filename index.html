<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ibrahim Family Tree ‚Äî Maijamaa (Full)</title>
<style>
  :root{
    --main: #006677;
    --accent: #0099aa;
    --bg: #f8f9fa;
    --card: #fff;
    --muted: #666;
    --text: #222;
  }
  [data-theme="dark"]{
    --bg: #0f1720;
    --card: #0b1220;
    --text: #e6eef2;
    --muted: #9aa6ad;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    padding-bottom:260px; /* for chat */
  }

  /* Topbar */
  .topbar{
    background:linear-gradient(90deg,var(--main),var(--accent));
    color:#fff;
    padding:12px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .left-controls{display:flex;gap:12px;align-items:center}
  .title{font-weight:700;letter-spacing:1px;margin-right:8px}
  .search { padding:8px 10px;border-radius:8px;border:none;width:260px }
  .admin-actions{display:flex;gap:8px;align-items:center}
  .btn { background:var(--card); color:var(--main); border:none; padding:8px 10px;border-radius:8px; cursor:pointer; font-weight:600 }
  .btn.primary { background:var(--main); color:#fff }
  .btn.ghost { background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.18) }

  /* controls */
  .controls{ width:min(1100px,96%); margin:12px auto; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .add-form { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .add-form input, .add-form select { padding:8px 10px; border-radius:8px; border:1px solid #d7e0e0; min-width:140px }
  .hint { color:var(--muted); font-size:13px }

  /* tree */
  .tree-wrap { width:min(1200px,98%); margin:8px auto 24px; padding:10px; overflow:auto; position:relative; border-radius:10px; touch-action:none; overscroll-behavior:contain; -webkit-overflow-scrolling:auto; background:transparent; cursor:grab }
  .tree-wrap.grabbing { cursor:grabbing }
  #connections { position:absolute; left:0; top:0; pointer-events:none; width:100%; height:100%; overflow:visible; z-index:1 }

  .tree { display:flex; justify-content:center; padding:20px 10px 80px; min-width:700px; z-index:2; }
  .tree ul { padding-top:28px; position:relative; display:inline-block; text-align:center; white-space:nowrap; }
  .tree li { display:inline-block; vertical-align:top; text-align:center; margin:0 16px; padding:0 6px 0 6px; position:relative; }

  .tree ul::before { content:''; position:absolute; top:0; left:50%; border-left:2px solid rgba(0,0,0,0.07); height:18px; transform:translateX(-50%); }
  .tree li::before, .tree li::after { content:''; position:absolute; top:18px; width:12px; height:2px; border-top:2px solid rgba(0,0,0,0.07); }
  .tree li::before{ right:50% } .tree li::after{ left:50% }
  .tree li:only-child::before, .tree li:only-child::after{ display:none }
  .tree li:first-child::before{ display:none } .tree li:last-child::after{ display:none }

  .card { background:var(--card); border-radius:12px; padding:12px 14px; width:200px; box-shadow:0 8px 18px rgba(0,0,0,0.08); border:2px solid rgba(0,0,0,0.04); cursor:pointer; transition:transform .16s ease, box-shadow .16s ease, border-color .16s ease; position:relative; z-index:3; }
  .card:hover{ transform:translateY(-6px); box-shadow:0 14px 28px rgba(0,0,0,0.12) }
  .name{ color:var(--main); font-weight:700; margin-bottom:6px }
  .role{ color:var(--muted); font-size:13px; margin-bottom:6px }
  .nick{ color:#000; font-weight:900; font-size:18px; margin-top:6px } /* bold nickname */

  .card.selected{ border-color:var(--accent); box-shadow:0 0 18px rgba(0,153,170,0.12) }
  .card.child-highlight{ box-shadow:0 0 20px rgba(0,153,170,0.18) !important; border-color:var(--accent) !important }

  .toggle-btn { position:absolute; right:8px; top:8px; width:26px; height:26px; border-radius:6px; border:none; background:var(--main); color:#fff; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; }
  .collapsed > ul { display:none }

  .card .small-actions { display:flex; gap:6px; justify-content:center; margin-top:8px }
  .small-actions button { padding:6px 8px; border-radius:8px; border:none; cursor:pointer; font-weight:600 }
  .small-actions .edit { background:#ffd966; color:#222 } /* edit */
  .small-actions .del { background:#ff6b6b; color:#fff } /* delete */

  .highlight { outline: 3px solid rgba(0,102,119,0.12); transform:translateY(-6px) }

  /* hovercard */
  .hover-card { position:fixed; z-index:120; background:var(--card); color:var(--text); border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,0.18); padding:10px; width:220px; display:none; }
  .hover-card h4{ margin:0 0 6px; font-size:16px }
  .hover-card .meta{ font-size:13px; color:var(--muted); margin-bottom:6px }

  /* chat */
  .chat-panel { position:fixed; left:12px; right:12px; bottom:12px; max-width:1200px; margin:0 auto; background:var(--card); border-radius:12px; box-shadow:0 18px 40px rgba(0,0,0,0.18); overflow:hidden; display:flex; flex-direction:column; height:260px; z-index:100 }
  .chat-header { background:var(--main); color:#fff; padding:8px 12px; font-weight:600; display:flex; justify-content:space-between; align-items:center }
  .chat-body { flex:1; padding:10px; overflow:auto; background:transparent; }
  .chat-footer { display:flex; gap:8px; padding:10px; border-top:1px solid #eee; background:var(--card); align-items:center }
  .chat-footer input, .chat-footer select { padding:8px 10px; border-radius:8px; border:1px solid #ddd; font-size:14px }
  .chat-footer button { background:var(--main); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer }
  .message { margin-bottom:8px; padding:8px; border-radius:8px; background:var(--card); box-shadow:0 2px 6px rgba(0,0,0,0.04) }
  .message .meta { font-size:12px; color:var(--muted); margin-bottom:6px }
  .message .reply-to { font-size:12px; color:var(--muted); margin-bottom:6px; font-style:italic }
  .message .text { font-size:14px; color:var(--text) }
  .reactions { margin-top:6px; display:flex; gap:6px; align-items:center; }
  .reactions button { background:transparent; border:none; cursor:pointer; font-size:16px }
  .gif-picker { display:flex; gap:6px; flex-wrap:wrap; max-width:280px }

  /* timeline */
  .timeline-panel { position:fixed; right:20px; top:100px; width:320px; max-height:60vh; overflow:auto; background:var(--card); padding:10px; border-radius:10px; box-shadow:0 18px 40px rgba(0,0,0,0.18); z-index:95 }
  .timeline-panel h4{ margin:0 0 8px }
  .timeline-item { padding:8px; border-bottom:1px solid rgba(0,0,0,0.04) }
  .timeline-item .time { font-size:12px; color:var(--muted) }

  /* modal */
  .modal-back { position:fixed; left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index:130 }
  .modal { background:var(--card); padding:16px; border-radius:12px; width:min(560px,94%); box-shadow:0 8px 30px rgba(0,0,0,0.25) }
  .modal h3 { margin:0 0 8px }
  .modal .row { display:flex; gap:8px; margin:8px 0; flex-wrap:wrap }
  .modal input, .modal select, .modal textarea { padding:8px 10px; border-radius:8px; border:1px solid #ddd; width:100% }
  .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:8px }

  .footer-note { text-align:center; color:var(--muted); font-size:13px; margin:20px 0 40px }

  @media (max-width:900px){
    .tree { min-width:900px } /* allow horizontal scroll */
    .search { width:170px }
    .add-form input { width:120px }
  }
  @media (max-width:480px){
    .card { width:150px }
    .nick { font-size:16px }
    .timeline-panel { display:none } /* hide timeline on small */
  }

</style>
</head>
<body data-theme="light">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="left-controls">
      <div class="title">MAIJAMAA Family Tree</div>
      <input id="searchInput" class="search" placeholder="Search by name or nickname..." />
    </div>
    <div class="admin-actions">
      <button id="themeBtn" class="btn">üåó Theme</button>
      <button id="loginBtn" class="btn ghost">üîê Login as Admin</button>
      <button id="logoutBtn" class="btn" style="display:none">üö™ Logout</button>
      <button id="exportBtn" class="btn">Export JSON</button>
      <button id="importBtn" class="btn">Import JSON</button>
      <button id="clearAllBtn" class="btn">Clear All</button>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="controls">
    <div class="add-form">
      <input id="inName" placeholder="Full name (required)" />
      <input id="inRole" placeholder="Role (e.g. Father)" />
      <input id="inNick" placeholder="Nickname (required)" />
      <select id="inParent"><option value="">‚Äî Parent (root) ‚Äî</option></select>
      <button id="addBtn" class="btn primary">+ Add (Admin)</button>
    </div>
    <div class="hint">Tip: Select parent to attach. Search works while tree updated.</div>
  </div>

  <!-- TREE -->
  <div class="tree-wrap" id="treeWrap" aria-label="Family tree area">
    <svg id="connections" xmlns="http://www.w3.org/2000/svg"></svg>
    <div id="treeRoot" class="tree" role="tree"></div>
  </div>

  <div class="footer-note">Tip: Click a card to select it and highlight direct children. Use +/- to hide/show subtrees.</div>

  <!-- TIMELINE (admin editable) -->
  <div class="timeline-panel" id="timelinePanel" aria-hidden="false">
    <h4>Family Timeline</h4>
    <div id="timelineList"></div>
    <div style="margin-top:8px; display:flex; gap:8px;">
      <button id="addEventBtn" class="btn">+ Event (Admin)</button>
      <button id="exportEventsBtn" class="btn">Export Events</button>
    </div>
  </div>

  <!-- HOVERCARD -->
  <div class="hover-card" id="hoverCard" role="dialog" aria-hidden="true"></div>

  <!-- CHAT -->
  <div class="chat-panel" role="region" aria-label="Family chat">
    <div class="chat-header">
      <div>Family Chat üí¨</div>
      <div style="font-size:13px;opacity:0.95">Saved locally on this device</div>
    </div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-footer">
      <select id="chatMember"><option value="">‚Äî Send as ‚Äî</option></select>
      <input id="chatInput" placeholder="Write a message... use @nickname: to reply" />
      <button id="gifBtn" class="btn">GIF</button>
      <button id="sendChat" class="btn primary">Send</button>
      <button id="clearChat" class="btn">Clear Chat</button>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-back" id="modalBack"><div class="modal" id="modal"></div></div>

<script>
/* ================== CONFIG & STORAGE KEYS ================== */
const ADMIN_NAME = 'Benalee';
const ADMIN_PASSWORD = 'Ab@58563';
const STORAGE_KEY = 'maijamaa_family_full_v1';
const CHAT_KEY = 'maijamaa_chat_full_v1';
const TIMELINE_KEY = 'maijamaa_timeline_v1';
const SETTINGS_KEY = 'maijamaa_settings_v1';
const BACKUP_REMINDER_KEY = 'maijamaa_backup_reminder_v1';

/* ================== STATE ================== */
let adminLoggedIn = false;
let family = loadJSON(STORAGE_KEY) || [
  { id:1, name: "Ibrahim", role: "Ancestor", nickname: "Mai Unguwa Mai Jama'a", parentId: null }
];
let chat = loadJSON(CHAT_KEY) || [];
let timeline = loadJSON(TIMELINE_KEY) || [];
let settings = loadJSON(SETTINGS_KEY) || { theme:'light', lastActivity: Date.now() };
let nextId = Math.max(0, ...family.map(f=>f.id)) + 1;
let autoLogoutTimer = null;
let warningTimeout = null;
const AUTO_LOGOUT_MS = 15 * 60 * 1000; // 15 minutes
const WARNING_BEFORE = 60 * 1000; // 1 minute

/* ================== DOM Refs ================== */
const treeRoot = document.getElementById('treeRoot');
const treeWrap = document.getElementById('treeWrap');
const svg = document.getElementById('connections');
const parentSelect = document.getElementById('inParent');
const addBtn = document.getElementById('addBtn');
const inName = document.getElementById('inName'), inRole = document.getElementById('inRole'), inNick = document.getElementById('inNick');
const loginBtn = document.getElementById('loginBtn'), logoutBtn = document.getElementById('logoutBtn');
const exportBtn = document.getElementById('exportBtn'), importBtn = document.getElementById('importBtn'), clearAllBtn = document.getElementById('clearAllBtn');
const searchInput = document.getElementById('searchInput');
const chatBody = document.getElementById('chatBody'), chatMember = document.getElementById('chatMember'), chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat'), clearChatBtn = document.getElementById('clearChat'), gifBtn = document.getElementById('gifBtn');
const themeBtn = document.getElementById('themeBtn');
const hoverCard = document.getElementById('hoverCard');
const timelinePanel = document.getElementById('timelinePanel'), timelineList = document.getElementById('timelineList'), addEventBtn = document.getElementById('addEventBtn');
const modalBack = document.getElementById('modalBack'), modal = document.getElementById('modal');

/* ================== UTIL ================== */
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function loadJSON(key){ try{ const r = localStorage.getItem(key); return r? JSON.parse(r): null }catch(e){ return null } }
function saveAll(){ saveJSON(STORAGE_KEY, family); saveJSON(CHAT_KEY, chat); saveJSON(TIMELINE_KEY, timeline); saveJSON(SETTINGS_KEY, settings); }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function findById(id){ return family.find(p=>p.id===id); }
function buildMap(){ const m=new Map(); family.forEach(p=>m.set(p.id,{...p, children:[]})); m.forEach(n=>{ if(n.parentId!=null && m.has(n.parentId)) m.get(n.parentId).children.push(n); }); return m; }
function getRoots(){ const map = buildMap(); const roots=[]; map.forEach(n=>{ if(n.parentId==null || !map.has(n.parentId)) roots.push(n); }); roots.sort((a,b)=>a.id-b.id); return roots; }

/* ================== RENDER TREE ================== */
function renderTree(){
  svg.innerHTML=''; treeRoot.innerHTML='';
  const map = buildMap();
  const roots = getRoots();
  const ul = document.createElement('ul'); ul.style.display='inline-block'; ul.style.textAlign='center';
  roots.forEach(root=> ul.appendChild(buildNode(root, map)));
  if(roots.length===0){ map.forEach(node=> ul.appendChild(buildNode(node, map))); }
  treeRoot.appendChild(ul);
  requestAnimationFrame(()=>{ drawConnections(); centerTree(); });
  setTimeout(()=>{ drawConnections(); centerTree(); }, 220); // help mobile settle
  rebuildParentDropdown(); rebuildChatMemberList(); saveJSON(STORAGE_KEY, family);
}

/* build node */
function buildNode(nodeData, map){
  const li = document.createElement('li'); li.dataset.id = nodeData.id;
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<div class="name">${escapeHtml(nodeData.name)}</div>
                    <div class="role">${escapeHtml(nodeData.role)}</div>
                    <div class="nick">${escapeHtml(nodeData.nickname||'')}</div>`;
  // toggle
  const toggle = document.createElement('button'); toggle.className='toggle-btn'; toggle.textContent='-';
  toggle.title='Collapse/Expand'; toggle.addEventListener('click', e=>{ e.stopPropagation(); li.classList.toggle('collapsed'); toggle.textContent = li.classList.contains('collapsed')? '+':'-'; requestAnimationFrame(drawConnections); });
  card.appendChild(toggle);

  // hover / tap show hovercard
  card.addEventListener('mouseenter', (e)=> showHoverCard(e, nodeData));
  card.addEventListener('mouseleave', hideHoverCard);
  card.addEventListener('click', (e)=>{
    e.stopPropagation();
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected','child-highlight'));
    card.classList.add('selected');
    const children = (map.get(nodeData.id) && map.get(nodeData.id).children) || [];
    children.forEach(ch=> {
      const ccard = document.querySelector(`li[data-id="${ch.id}"] .card`);
      if(ccard) ccard.classList.add('child-highlight');
    });
    if(children.length>0){
      const first = document.querySelector(`li[data-id="${children[0].id}"]`);
      if(first) first.scrollIntoView({behavior:'smooth', block:'center', inline:'center'});
    }
  });

  // admin small actions
  const act = document.createElement('div'); act.className='small-actions';
  const editBtn = document.createElement('button'); editBtn.className='edit'; editBtn.textContent='Edit';
  const delBtn = document.createElement('button'); delBtn.className='del'; delBtn.textContent='Delete';
  editBtn.addEventListener('click',(ev)=>{ ev.stopPropagation(); openEditModal(nodeData.id); });
  delBtn.addEventListener('click',(ev)=>{ ev.stopPropagation(); confirmDelete(nodeData.id); });
  act.appendChild(editBtn); act.appendChild(delBtn);
  card.appendChild(act);

  li.appendChild(card);

  const children = (map.get(nodeData.id) && map.get(nodeData.id).children) || [];
  if(children.length>0){
    const sub = document.createElement('ul');
    children.sort((a,b)=>a.id-b.id).forEach(ch => sub.appendChild(buildNode(ch, map)));
    li.appendChild(sub);
  }
  return li;
}

/* draw connectors */
function drawConnections(){
  const wrapRect = treeWrap.getBoundingClientRect();
  svg.setAttribute('width', wrapRect.width); svg.setAttribute('height', wrapRect.height); svg.style.left='0'; svg.style.top='0';
  while(svg.firstChild) svg.removeChild(svg.firstChild);
  const lis = treeRoot.querySelectorAll('li[data-id]');
  lis.forEach(li=>{
    const children = li.querySelectorAll(':scope > ul > li[data-id]');
    if(children.length===0) return;
    const parentCard = li.querySelector(':scope > .card');
    if(!parentCard) return;
    const pRect = parentCard.getBoundingClientRect();
    children.forEach(childLi=>{
      const childCard = childLi.querySelector(':scope > .card'); if(!childCard) return;
      const cRect = childCard.getBoundingClientRect();
      const startX = pRect.left + pRect.width/2 - wrapRect.left;
      const startY = pRect.bottom - wrapRect.top;
      const endX = cRect.left + cRect.width/2 - wrapRect.left;
      const endY = cRect.top - wrapRect.top;
      const dx = (endY - startY) * 0.6;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      const d = `M ${startX} ${startY} C ${startX} ${startY + dx} ${endX} ${endY - dx} ${endX} ${endY}`;
      path.setAttribute('d', d); path.setAttribute('fill','none'); path.setAttribute('stroke','rgba(0,0,0,0.08)'); path.setAttribute('stroke-width','2');
      svg.appendChild(path);
      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx', endX); circle.setAttribute('cy', endY); circle.setAttribute('r','3'); circle.setAttribute('fill','rgba(0,0,0,0.06)');
      svg.appendChild(circle);
    });
  });
}

/* center tree */
function centerTree(){
  try{
    const ul = treeRoot.querySelector('ul'); if(!ul) return;
    const wrap = treeWrap;
    const contentLeft = ul.offsetLeft;
    const targetLeft = contentLeft + (ul.offsetWidth/2) - (wrap.clientWidth/2);
    const contentTop = ul.offsetTop;
    const targetTop = contentTop + (ul.offsetHeight/2) - (wrap.clientHeight/2);
    const maxLeft = Math.max(0, wrap.scrollWidth - wrap.clientWidth);
    const maxTop = Math.max(0, wrap.scrollHeight - wrap.clientHeight);
    const left = Math.max(0, Math.min(maxLeft, targetLeft));
    const top = Math.max(0, Math.min(maxTop, targetTop));
    wrap.scrollTo({ left, top, behavior:'smooth' });
  }catch(e){}
}

/* rebuild parent dropdown */
function rebuildParentDropdown(){
  const cur = parentSelect.value;
  parentSelect.innerHTML = '<option value="">‚Äî Parent (root)
